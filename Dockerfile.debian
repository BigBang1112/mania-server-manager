FROM --platform=$BUILDPLATFORM mcr.microsoft.com/dotnet/sdk:9.0-bookworm-slim AS build
ARG TARGETARCH
WORKDIR /src

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy project file and restore as distinct layers
COPY ManiaServerManager/*.csproj .
RUN dotnet restore -r linux-$TARGETARCH

# Copy source code and publish app
COPY ManiaServerManager/. .
RUN dotnet publish --no-restore -o /app
RUN rm /app/*.dbg


# Final stage/image
FROM mcr.microsoft.com/dotnet/runtime-deps:9.0-bookworm-slim

WORKDIR /app
COPY --from=build /app .
COPY --chown=$APP_UID:$APP_UID entrypoint.sh .
RUN chmod +x entrypoint.sh

RUN mkdir -p /app/data/archives /app/data/versions && \
    chown -R $APP_UID:$APP_UID /app/data && \
    chmod -R u+w /app/data

EXPOSE 2350/tcp 2350/udp 3450/tcp 3450/udp

USER $APP_UID
ENTRYPOINT ["./entrypoint.sh"]
